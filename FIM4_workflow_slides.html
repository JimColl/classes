<!DOCTYPE html>
<html lang="en"><head>
<link href="./_favlogo.png" rel="icon" type="image/png">
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.42">

  <title>So long as you get the GIS&amp;T of it – fim4_workflow_slides</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto-88a9298778b4231bab08b139834103b4.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">


<section class="slide level2">

<p>RAS tifs RAS2FIM Illinois</p>
</section>
<section id="the-fim4-algorithm-via-codebase-decomposition" class="slide level2" data-background-color="white" data-background-image="./_vecteezy_ai-generated-water-wave-splash.png" data-background-size="contain">
<h2>The FIM4 Algorithm (via Codebase Decomposition)</h2>
<p>```{{r, setup, warning = FALSE, echo = FALSE, results=‘hide’}} library(magrittr) library(rgl, quietly=T) knitr::knit_hooks$set(webgl = hook_webgl)</p>
<p>unit_to_map &lt;- ‘01050002’</p>
<p>path_to_output &lt;- file.path(“C:/Users/stick/root/Dropbox/root/projects/floodmapping/tools/FrankenFIM/FrankenFIM/vignettes/vis”,fsep=.Platform<span class="math inline">\(file.sep)
path_to_tmp_output &lt;- file.path(path_to_output,"tmp",fsep = .Platform\)</span>file.sep) path_to_maine_stock &lt;- file.path(“C:/Users/stick/root//Dropbox/root/projects/floodmapping/methods/OWP_FIM/outputs/FIM4_maine/”,fsep = .Platform$file.sep)</p>
<p>path_to_fim4_unit_outputs &lt;- path_to_maine_stock</p>
<p>all_hucs &lt;- sf::st_read(file.path(“C:/Users/stick/root//Dropbox/root/database/hosted/water/HUC8.fgb”,fsep = .Platform$file.sep))</p>
<p>wbd8_clp_inputs &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,“wbd8_clp.gpkg”,fsep=.Platform<span class="math inline">\(file.sep))
levelpaths &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"nwm_subset_streams_levelPaths.gpkg",fsep = .Platform\)</span>file.sep)) nearby_hucs &lt;- sf::st_transform(all_hucs,sf::st_crs(wbd8_clp_inputs))[wbd8_clp_inputs %&gt;% sf::st_buffer(1000),]</p>
<p>test_pkg &lt;- file.path(“~/data/temp/test.gpkg”,fsep = .Platform$file.sep) hf_flowpaths &lt;- sf::read_sf(test_pkg, “flowpaths”) hf_divides &lt;- sf::read_sf(test_pkg, “divides”) hf_flowlines &lt;- sf::read_sf(test_pkg, “flowlines”) hf_network &lt;- sf::read_sf(test_pkg, “network”)</p>
<p>huc_flowpaths &lt;- hf_flowpaths[wbd8_clp_inputs[4,],] huc_divides &lt;- hf_divides[hf_divides<span class="math inline">\(id %in% huc_flowpaths\)</span>divide_id,] huc_network &lt;- hf_network[hf_network<span class="math inline">\(divide_id %in% huc_flowpaths\)</span>divide_id,]</p>
<p>huc_bbox &lt;- sf::st_bbox(sf::st_transform(huc_divides,sf::st_crs(‘EPSG:4326’))) %&gt;% unlist() %&gt;% unname()</p>
<p>hf_bounds &lt;- sf::st_bbox(sf::st_transform(huc_divides,sf::st_crs(‘EPSG:4326’))) %&gt;% unlist() %&gt;% unname()</p>
<p>branch_polys &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,“branch_polygons.gpkg”,fsep = .Platform$file.sep)) branch_polys_selction &lt;- branch_polys[25,] #2,11, 19 aoi_bbox &lt;- sf::st_bbox(sf::st_transform(branch_polys_selction,sf::st_crs(‘EPSG:4326’))) %&gt;% unlist() %&gt;% unname()</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a></a></span>
<span id="cb1-2"><a></a><span class="fu">## Reminder: Last time {data-background-image="Water_bw.png"}</span></span>
<span id="cb1-3"><a></a></span>
<span id="cb1-4"><a></a><span class="ss">* </span>Flowpath: The HY_Features (OGC-16-032r2) are defined such that we use the term to describe "whatever exists as part of a network of waterbody and surface depressions and surfance channels" and we represent as a linear centerline</span>
<span id="cb1-5"><a></a><span class="ss">* </span>Divide: Divides are the polygon partitoning of the landscape</span>
<span id="cb1-6"><a></a><span class="ss">* </span>Flowline: A flowline is a one-dimensional (linear) feature that represents a flowing body of water and is functional similar to a flowpath but does not realize the catchment concept.</span>
<span id="cb1-7"><a></a></span>
<span id="cb1-8"><a></a><span class="al">![](./vis/flowline_flowpath.png)</span>{fig-align="center" height="80%"}</span>
<span id="cb1-9"><a></a></span>
<span id="cb1-10"><a></a><span class="at">&gt; From: Hydrologic Modeling and River Corridor Applications of HY_Features Concepts. https://docs.ogc.org/per/22-040.html. and Figure 9 reproduced.</span></span>
<span id="cb1-11"><a></a></span>
<span id="cb1-12"><a></a><span class="fu">## Hydrofabric for VPU 1</span></span>
<span id="cb1-13"><a></a></span>
<span id="cb1-14"><a></a><span class="in">```{r, VPU, warning = FALSE, echo = FALSE}</span></span>
<span id="cb1-15"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("VPU1_HF.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb1-16"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb1-17"><a></a><span class="in">  </span></span>
<span id="cb1-18"><a></a><span class="in">  hf_bounds &lt;- sf::st_bbox(sf::st_transform(hf_divides,sf::st_crs('EPSG:4326'))) %&gt;% unlist() %&gt;% unname()</span></span>
<span id="cb1-19"><a></a><span class="in">  hf_divide_values &lt;- unique(hf_divides$divide_id)</span></span>
<span id="cb1-20"><a></a><span class="in">  # hf_divide_pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(hf_divide_values)),hf_divide_values,na.color = "transparent")</span></span>
<span id="cb1-21"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb1-22"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb1-23"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(hf_divides,sf::st_crs('EPSG:4326')),stroke = TRUE, opacity = 0.8,fillOpacity = 0,fill = FALSE,weight = 1) %&gt;%</span></span>
<span id="cb1-24"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(hf_flowpaths,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="blue") %&gt;%</span></span>
<span id="cb1-25"><a></a><span class="in">    # leaflet::addLabelOnlyMarkers(data=sf::st_transform(forecast_basins %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb1-26"><a></a><span class="in">    #                              label = ~`ID`,</span></span>
<span id="cb1-27"><a></a><span class="in">    #                              labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb1-28"><a></a><span class="in">    #                              group="Index Labels") %&gt;%</span></span>
<span id="cb1-29"><a></a><span class="in">    leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4])</span></span>
<span id="cb1-30"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb1-31"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb1-32"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb1-33"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb1-34"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("VPU1_HF.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb1-35"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./vis/VPU1_HF.png" class="quarto-figure quarto-figure-center" style="height:80.0%"></p>
</figure>
</div>
</section>
<section id="focus-in-on-huc01050002" class="slide level2">
<h2>Focus in on HUC:01050002</h2>
<p>```{{r, tVPU, warning = FALSE, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“VPU1_HF_HUC.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p>map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;% leaflet::addProviderTiles(“CartoDB.Positron”,group = “CartoDB.Positron”) %&gt;% leafem::addFeatures(data = sf::st_transform(hf_flowpaths,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“blue”) %&gt;% leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs[4,],sf::st_crs(‘EPSG:4326’)),stroke = TRUE,opacity = 1,fillOpacity = 0,weight = 0.2,color=“black”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% leaflet::addLabelOnlyMarkers(data=sf::st_transform(nearby_hucs %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs(‘EPSG:4326’)), label = ~<code>name</code>, labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T), group=“Index Labels”) %&gt;% leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4]) mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_output,glue::glue(“VPU1_HF_HUC.png”),fsep = .Platform$file.sep)) }</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a></a></span>
<span id="cb2-2"><a></a><span class="al">![](./vis/VPU1_HF_HUC.png)</span></span>
<span id="cb2-3"><a></a></span>
<span id="cb2-4"><a></a><span class="fu">## Focus in on HUC:01050002</span></span>
<span id="cb2-5"><a></a></span>
<span id="cb2-6"><a></a><span class="in">```{r, HUC, warning = FALSE, echo = FALSE}</span></span>
<span id="cb2-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb2-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb2-9"><a></a><span class="in">  </span></span>
<span id="cb2-10"><a></a><span class="in">  huc_flowpaths &lt;- hf_flowpaths[wbd8_clp_inputs[4,],]</span></span>
<span id="cb2-11"><a></a><span class="in">  huc_divides &lt;- hf_divides[hf_divides$id %in% huc_flowpaths$divide_id,]</span></span>
<span id="cb2-12"><a></a><span class="in">  huc_network &lt;- hf_network[hf_network$divide_id %in% huc_flowpaths$divide_id,]</span></span>
<span id="cb2-13"><a></a><span class="in">  </span></span>
<span id="cb2-14"><a></a><span class="in">  hf_bounds &lt;- sf::st_bbox(sf::st_transform(huc_divides,sf::st_crs('EPSG:4326'))) %&gt;% unlist() %&gt;% unname()</span></span>
<span id="cb2-15"><a></a><span class="in">  hf_divide_values &lt;- unique(huc_divides$divide_id)</span></span>
<span id="cb2-16"><a></a><span class="in">  hf_divide_pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(hf_divide_values)),hf_divide_values,na.color = "transparent")</span></span>
<span id="cb2-17"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb2-18"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb2-19"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(huc_divides,sf::st_crs('EPSG:4326')),stroke = TRUE, opacity = 0.8,fillOpacity = 0,fill = FALSE,weight = 1) %&gt;%</span></span>
<span id="cb2-20"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs[4,],sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 0,weight = 0.2,color="black") %&gt;%</span></span>
<span id="cb2-21"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(huc_flowpaths,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="blue") %&gt;%</span></span>
<span id="cb2-22"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb2-23"><a></a><span class="in">    leaflet::addLabelOnlyMarkers(data=sf::st_transform(nearby_hucs %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb2-24"><a></a><span class="in">                                 label = ~`name`,</span></span>
<span id="cb2-25"><a></a><span class="in">                                 labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb2-26"><a></a><span class="in">                                 group="Index Labels") %&gt;%</span></span>
<span id="cb2-27"><a></a><span class="in">    leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4])</span></span>
<span id="cb2-28"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb2-29"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb2-30"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb2-31"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb2-32"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("HUC01050002.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb2-33"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002.png"></p>
</section>
<section id="and-by-divide" class="slide level2">
<h2>And By Divide</h2>
<p>```{{r,divide, warning = FALSE, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_divide.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p>huc_flowpaths &lt;- hf_flowpaths[wbd8_clp_inputs[4,],] huc_divides &lt;- hf_divides[hf_divides<span class="math inline">\(id %in% huc_flowpaths\)</span>divide_id,] huc_network &lt;- hf_network[hf_network<span class="math inline">\(divide_id %in% huc_flowpaths\)</span>divide_id,]</p>
<p>hf_bounds &lt;- sf::st_bbox(sf::st_transform(huc_divides,sf::st_crs(‘EPSG:4326’))) %&gt;% unlist() %&gt;% unname() hf_divide_values &lt;- unique(huc_divides<span class="math inline">\(divide_id)
  hf_divide_pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(hf_divide_values)),hf_divide_values,na.color = "transparent")
  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%
    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%
    leafem::addFeatures(data = sf::st_transform(huc_divides,sf::st_crs('EPSG:4326')),stroke = TRUE, opacity = 0.8,fillOpacity = 1,fill = TRUE,weight = 1,fillColor=hf_divide_pal(huc_divides\)</span>divide_id)) %&gt;% leafem::addFeatures(data = sf::st_transform(huc_flowpaths,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“blue”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% leaflet::addLabelOnlyMarkers(data=sf::st_transform(nearby_hucs %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs(‘EPSG:4326’)), label = ~<code>name</code>, labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T), group=“Index Labels”) %&gt;% leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4]) mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_output,glue::glue(“HUC01050002_divide.png”),fsep = .Platform$file.sep)) }</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb3-1"><a></a></span>
<span id="cb3-2"><a></a><span class="al">![](./vis/HUC01050002_divide.png)</span></span>
<span id="cb3-3"><a></a></span>
<span id="cb3-4"><a></a><span class="fu">## What does this network look like?</span></span>
<span id="cb3-5"><a></a></span>
<span id="cb3-6"><a></a><span class="in">```{r, visNetwork1, echo = FALSE}</span></span>
<span id="cb3-7"><a></a><span class="in">huc_flowpaths &lt;- hf_flowpaths[wbd8_clp_inputs[4,],]</span></span>
<span id="cb3-8"><a></a><span class="in">huc_divides &lt;- hf_divides[hf_divides$id %in% huc_flowpaths$divide_id,]</span></span>
<span id="cb3-9"><a></a><span class="in">huc_network &lt;- hf_network[hf_network$divide_id %in% huc_flowpaths$divide_id,]</span></span>
<span id="cb3-10"><a></a><span class="in">g = dplyr::select(huc_network, id, toid) %&gt;%</span></span>
<span id="cb3-11"><a></a><span class="in">  dplyr::distinct() %&gt;%</span></span>
<span id="cb3-12"><a></a><span class="in">  igraph::graph_from_data_frame(directed = TRUE) </span></span>
<span id="cb3-13"><a></a><span class="in">visNetwork::visIgraph(g) %&gt;%</span></span>
<span id="cb3-14"><a></a><span class="in">  visNetwork::visOptions(highlightNearest = list(enabled = T, hover = T), nodesIdSelection = T)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fim-pipeline" class="slide level2">
<h2>FIM Pipeline</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./vis/largescaleoverview.jpg" class="quarto-figure quarto-figure-center" style="height:80.0%"></p>
</figure>
</div>
</section>
<section id="fim-pipeline-1" class="slide level2">
<h2>FIM Pipeline</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./vis/stepscaleoverview.jpg" class="quarto-figure quarto-figure-center" style="height:80.0%"></p>
</figure>
</div>
</section>
<section id="stepping-through-the-pipeline" class="slide level2">
<h2>Stepping through the pipeline</h2>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="./vis/FIM4_diagram.png" class="quarto-figure quarto-figure-center" style="height:80.0%"></p>
</figure>
</div>
</section>
<section id="the-fim-pipeline-derive-levelpaths" class="slide level2">
<h2>The FIM Pipeline: Derive Levelpaths</h2>
<p>```{{r, lelvepaths, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_levels.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p>branch_polys &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,“branch_polygons.gpkg”,fsep = .Platform$file.sep)) map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;% leaflet::addProviderTiles(“CartoDB.Positron”,group = “CartoDB.Positron”) %&gt;% # leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs(‘EPSG:4326’)),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.02,color=“black”) %&gt;% leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs(‘EPSG:4326’)),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color=“#0327cd”) %&gt;% leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color=“#000000”) %&gt;% leaflet::addLabelOnlyMarkers(data=sf::st_transform(branch_polys %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs(‘EPSG:4326’)), label = ~<code>levpa_id</code>, labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T), group=“Index Labels”) %&gt;% leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4])</p>
<p>mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_output,glue::glue(“HUC01050002_levels.png”),fsep = .Platform$file.sep)) }</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a></a></span>
<span id="cb4-2"><a></a><span class="al">![](./vis/HUC01050002_levels.png)</span></span>
<span id="cb4-3"><a></a></span>
<span id="cb4-4"><a></a><span class="fu">## Aside: What does SCHISM see?</span></span>
<span id="cb4-5"><a></a></span>
<span id="cb4-6"><a></a><span class="in">```{r, bs, echo = FALSE}</span></span>
<span id="cb4-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002_schism.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb4-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb4-9"><a></a><span class="in">  </span></span>
<span id="cb4-10"><a></a><span class="in">  basedir &lt;- "~/data/raw/nohrsc/owp_files/nwm/nwm_parameters/NWM_coastal_parameters.tar/coastal_parameters/coastal/atlgulf/"</span></span>
<span id="cb4-11"><a></a><span class="in">  hgrid.gr3_file &lt;- file.path(basedir,"hgrid.gr3")</span></span>
<span id="cb4-12"><a></a><span class="in">  hgrid.gr3 &lt;- data.table::fread(hgrid.gr3_file,skip = 2,nrows = 10537611-2)</span></span>
<span id="cb4-13"><a></a><span class="in">  hgrid.gr3_sf &lt;- sfheaders::sf_point(</span></span>
<span id="cb4-14"><a></a><span class="in">    obj = hgrid.gr3</span></span>
<span id="cb4-15"><a></a><span class="in">    , x = "V2"</span></span>
<span id="cb4-16"><a></a><span class="in">    , y = "V3"</span></span>
<span id="cb4-17"><a></a><span class="in">    , z = "V4"</span></span>
<span id="cb4-18"><a></a><span class="in">    , keep = TRUE</span></span>
<span id="cb4-19"><a></a><span class="in">  ) |&gt; sf::st_set_crs(sf::st_crs("EPSG:6349")) %&gt;% </span></span>
<span id="cb4-20"><a></a><span class="in">    sf::st_transform(sf::st_crs("EPSG:4326"))</span></span>
<span id="cb4-21"><a></a><span class="in">  schism_pts &lt;- hgrid.gr3_sf[sf::st_transform(wbd8_clp_inputs,sf::st_crs(hgrid.gr3_sf)) %&gt;% sf::st_make_valid(),]</span></span>
<span id="cb4-22"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb4-23"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb4-24"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs('EPSG:4326')),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.1,color="black") %&gt;%</span></span>
<span id="cb4-25"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb4-26"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb4-27"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb4-28"><a></a><span class="in">    leaflet::addLabelOnlyMarkers(data=sf::st_transform(nearby_hucs %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb4-29"><a></a><span class="in">                                 label = ~`name`,</span></span>
<span id="cb4-30"><a></a><span class="in">                                 labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb4-31"><a></a><span class="in">                                 group="Index Labels") %&gt;%</span></span>
<span id="cb4-32"><a></a><span class="in">    leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4])</span></span>
<span id="cb4-33"><a></a></span>
<span id="cb4-34"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb4-35"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb4-36"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb4-37"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb4-38"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("HUC01050002_schism.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb4-39"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002_schism.png"></p>
</section>
<section id="the-fim-pipeline-target-branch" class="slide level2">
<h2>The FIM Pipeline: Target branch</h2>
<p>```{{r, tlevelpath, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_levels_select.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p>branch_polys &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,“branch_polygons.gpkg”,fsep = .Platform$file.sep)) branch_polys_selction &lt;- branch_polys[25,] #2,11, 19 map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;% leaflet::addProviderTiles(“CartoDB.Positron”,group = “CartoDB.Positron”) %&gt;% # leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs(‘EPSG:4326’)),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.02,color=“black”) %&gt;% leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs(‘EPSG:4326’)),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color=“#0327cd”) %&gt;% leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color=“yellow”) %&gt;% leaflet::addLabelOnlyMarkers(data=sf::st_transform(branch_polys %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs(‘EPSG:4326’)), label = ~<code>levpa_id</code>, labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T), group=“Index Labels”) %&gt;% leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4])</p>
<p>mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_output,glue::glue(“HUC01050002_levels_select.png”),fsep = .Platform$file.sep)) }</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb5-1"><a></a></span>
<span id="cb5-2"><a></a><span class="al">![](./vis/HUC01050002_levels_select.png)</span></span>
<span id="cb5-3"><a></a></span>
<span id="cb5-4"><a></a><span class="fu">## The FIM Pipeline: Target branch callout</span></span>
<span id="cb5-5"><a></a></span>
<span id="cb5-6"><a></a><span class="in">```{r, slevelpath, echo = FALSE}</span></span>
<span id="cb5-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002_levels_select_lone.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb5-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb5-9"><a></a><span class="in">  </span></span>
<span id="cb5-10"><a></a><span class="in">  branch_polys &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"branch_polygons.gpkg",fsep = .Platform$file.sep))</span></span>
<span id="cb5-11"><a></a><span class="in">  branch_polys_selction &lt;- branch_polys[25,] #2,11, 19</span></span>
<span id="cb5-12"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb5-13"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb5-14"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs('EPSG:4326')),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.02,color="black") %&gt;%</span></span>
<span id="cb5-15"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb5-16"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb5-17"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb5-18"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(branch_polys,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb5-19"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color="yellow") %&gt;%</span></span>
<span id="cb5-20"><a></a><span class="in">    # leaflet::addLabelOnlyMarkers(data=sf::st_transform(branch_polys %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb5-21"><a></a><span class="in">    #                              label = ~`levpa_id`,</span></span>
<span id="cb5-22"><a></a><span class="in">    #                              labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb5-23"><a></a><span class="in">    #                              group="Index Labels") %&gt;%</span></span>
<span id="cb5-24"><a></a><span class="in">    leaflet::fitBounds(hf_bounds[3],hf_bounds[2],hf_bounds[1],hf_bounds[4])</span></span>
<span id="cb5-25"><a></a></span>
<span id="cb5-26"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb5-27"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb5-28"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb5-29"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb5-30"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("HUC01050002_levels_select_lone.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb5-31"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002_levels_select_lone.png"></p>
</section>
<section id="the-fim-pipeline-target-branch-1" class="slide level2">
<h2>The FIM Pipeline: Target branch</h2>
<p>```{{r, tbranch, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_selectlevel.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p>branch_polys &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,“branch_polygons.gpkg”,fsep = .Platform<span class="math inline">\(file.sep))
  branch_polys_selction &lt;- branch_polys[25,] #2,11, 19
  aoi_bbox &lt;- sf::st_bbox(sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326'))) %&gt;% unlist() %&gt;% unname()
  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%
    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%
    # leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs('EPSG:4326')),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.02,color="black") %&gt;%
    leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths\)</span>levpa_id==branch_polys_selction$levpa_id,],sf::st_crs(‘EPSG:4326’)),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color=“#0327cd”) %&gt;% leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% # leafem::addFeatures(data = sf::st_transform(branch_polys,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color=“yellow”) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 0.2,weight = 1,color=“#000000”) %&gt;% leaflet::addLabelOnlyMarkers(data=sf::st_transform(branch_polys_selction %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs(‘EPSG:4326’)), label = ~<code>levpa_id</code>, labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T), group=“Index Labels”) %&gt;% # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4]) leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</p>
<p>mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_output,glue::glue(“HUC01050002_selectlevel.png”),fsep = .Platform$file.sep)) }</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a></a></span>
<span id="cb6-2"><a></a><span class="al">![](./vis/HUC01050002_selectlevel.png)</span></span>
<span id="cb6-3"><a></a></span>
<span id="cb6-4"><a></a><span class="fu">## The FIM Pipeline: DEM</span></span>
<span id="cb6-5"><a></a></span>
<span id="cb6-6"><a></a><span class="in">```{r,dem, echo = FALSE}</span></span>
<span id="cb6-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002_selectlevel_DEM.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb6-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb6-9"><a></a><span class="in">  </span></span>
<span id="cb6-10"><a></a><span class="in">  dem_meters &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("dem_meters_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb6-11"><a></a></span>
<span id="cb6-12"><a></a><span class="in">  gg_df &lt;- as.data.frame(dem_meters,xy = T)</span></span>
<span id="cb6-13"><a></a><span class="in">  gglegend &lt;- ggplot2::ggplot() +</span></span>
<span id="cb6-14"><a></a><span class="in">    ggplot2::geom_raster(data = gg_df, ggplot2::aes(x = x, y = y, fill = dem_meters_2678000065)) +</span></span>
<span id="cb6-15"><a></a><span class="in">    ggplot2::scale_fill_stepsn(name = "3DEP 10m (m)", </span></span>
<span id="cb6-16"><a></a><span class="in">                               colors =c("forestgreen","yellow","tan","brown"),</span></span>
<span id="cb6-17"><a></a><span class="in">                               breaks = round(seq(plyr::round_any(min(na.omit(gg_df$dem_meters_2678000065)), 10, f = floor),</span></span>
<span id="cb6-18"><a></a><span class="in">                                            plyr::round_any(max(na.omit(gg_df$dem_meters_2678000065)), 10, f = ceiling), length = 7), 1),</span></span>
<span id="cb6-19"><a></a><span class="in">                               values = scales::rescale(</span></span>
<span id="cb6-20"><a></a><span class="in">                                 seq(plyr::round_any(min(na.omit(gg_df$dem_meters_2678000065)), 10, f = floor),</span></span>
<span id="cb6-21"><a></a><span class="in">                                     plyr::round_any(max(na.omit(gg_df$dem_meters_2678000065)), 10, f = ceiling), length = 6)))</span></span>
<span id="cb6-22"><a></a><span class="in">  llegend &lt;- cowplot::get_legend(gglegend)</span></span>
<span id="cb6-23"><a></a><span class="in">  cowplot::save_plot(plot=cowplot::plot_grid(llegend),filename=file.path(path_to_tmp_output,glue::glue("test_legend.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb6-24"><a></a><span class="in">  pal &lt;- leaflet::colorNumeric(c("forestgreen","yellow","tan","brown"), terra::values(dem_meters),na.color = "transparent")</span></span>
<span id="cb6-25"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb6-26"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb6-27"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb6-28"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths$levpa_id==branch_polys_selction$levpa_id,],sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb6-29"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb6-30"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb6-31"><a></a><span class="in">    # leafem::addGeoRaster(dem_meters,colorOptions = leafem:::colorOptions(palette = pal,</span></span>
<span id="cb6-32"><a></a><span class="in">    #                                                                      # breaks = as.numeric(c(0:xx$max_ffreq)),</span></span>
<span id="cb6-33"><a></a><span class="in">    #                                                                      domain = c(dem_meters_values_min,dem_meters_values_max))) %&gt;%</span></span>
<span id="cb6-34"><a></a><span class="in">    # leafem::addGeoRaster(dem_meters,color= pal) %&gt;%</span></span>
<span id="cb6-35"><a></a><span class="in">    leaflet::addRasterImage(dem_meters, colors = pal, opacity = 0.9,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb6-36"><a></a><span class="in">    # leaflet::addLegend("bottomleft",title = "3DEP 10m (m)", pal = pal, values = terra::values(dem_meters)) %&gt;% </span></span>
<span id="cb6-37"><a></a><span class="in">    leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb6-38"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb6-39"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb6-40"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb6-41"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb6-42"><a></a><span class="in">    ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb6-43"><a></a><span class="in">  map &lt;- magick::image_read(file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb6-44"><a></a><span class="in">  legend &lt;- magick::image_read(file.path(path_to_tmp_output,glue::glue("test_legend.png"),fsep = .Platform$file.sep)) %&gt;% </span></span>
<span id="cb6-45"><a></a><span class="in">    magick::image_trim() %&gt;% </span></span>
<span id="cb6-46"><a></a><span class="in">    magick::image_fill(</span></span>
<span id="cb6-47"><a></a><span class="in">      color = "transparent", </span></span>
<span id="cb6-48"><a></a><span class="in">      refcolor = "white", </span></span>
<span id="cb6-49"><a></a><span class="in">      fuzz = 4,</span></span>
<span id="cb6-50"><a></a><span class="in">      point = "+1+1"</span></span>
<span id="cb6-51"><a></a><span class="in">    ) %&gt;% </span></span>
<span id="cb6-52"><a></a><span class="in">    magick::image_scale("200")</span></span>
<span id="cb6-53"><a></a><span class="in">  magick::image_write(image = magick::image_mosaic(c(map, legend)),path=file.path(path_to_output,glue::glue("HUC01050002_selectlevel_DEM.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb6-54"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002_selectlevel_DEM.png"></p>
</section>
<section id="the-fim-pipeline-flow-girds-boolean" class="slide level2">
<h2>The FIM Pipeline: Flow Girds (boolean)</h2>
<p>```{{r, fgrids,echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_flows_grid_boolean.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p>flows_grid_boolean &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,“branches”,branch_polys_selction<span class="math inline">\(levpa_id,glue::glue("flows_grid_boolean_{branch_polys_selction\)</span>levpa_id}.tif”),fsep = .Platform<span class="math inline">\(file.sep)) %&gt;%
  terra::classify(cbind(-Inf, 0, NA), right=TRUE)
  pal &lt;- leaflet::colorFactor(c("black","blue"), c(0,1),na.color = "transparent")
  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%
    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%
    # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%
    # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%
    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%
    leaflet::addRasterImage(flows_grid_boolean, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%
    leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])
  # addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")
  map1
  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep),vwidth = 1080,vheight = 1080) magick::image_write( magick::image_read( cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep), border_size = 4,just = "center")
    ),file.path(path_to_output,glue::glue("HUC01050002_selectlevel_flows_grid_boolean.png"),fsep = .Platform\)</span>file.sep)) }</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a></a></span>
<span id="cb7-2"><a></a><span class="al">![](./vis/HUC01050002_selectlevel_flows_grid_boolean.png)</span></span>
<span id="cb7-3"><a></a></span>
<span id="cb7-4"><a></a><span class="fu">## The FIM Pipeline: Headwaters</span></span>
<span id="cb7-5"><a></a></span>
<span id="cb7-6"><a></a><span class="in">```{r, heads,echo = FALSE}</span></span>
<span id="cb7-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002_selectlevel_headwaters.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb7-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb7-9"><a></a><span class="in">  </span></span>
<span id="cb7-10"><a></a><span class="in">  headwaters &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"nwm_headwater_points_subset.gpkg",fsep = .Platform$file.sep))</span></span>
<span id="cb7-11"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb7-12"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb7-13"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb7-14"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb7-15"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb7-16"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb7-17"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(headwaters,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,radius = 2,color="#FF0000") %&gt;%</span></span>
<span id="cb7-18"><a></a><span class="in">    # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb7-19"><a></a><span class="in">    leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb7-20"><a></a><span class="in">  # addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb7-21"><a></a><span class="in">  map1</span></span>
<span id="cb7-22"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb7-23"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb7-24"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb7-25"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb7-26"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("HUC01050002_selectlevel_headwaters.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb7-27"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002_selectlevel_headwaters.png"></p>
</section>
<section id="the-fim-pipeline-flow-direction" class="slide level2">
<h2>The FIM Pipeline: Flow Direction</h2>
<p>```{{r,fd, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_flowdir.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p># flowdir_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,“flowdir_d8_burned_filled.tif”,fsep = .Platform<span class="math inline">\(file.sep))
  flowdir_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction\)</span>levpa_id,glue::glue(“flowdir_d8_burned_filled_{branch_polys_selction<span class="math inline">\(levpa_id}.tif"),fsep = .Platform\)</span>file.sep)) pal &lt;- leaflet::colorFactor(c(”#862627”,“#26207a”,“#6563b7”,“#6563b7”,“#cbc6c0”,“#fee08a”,“#f4a429”,“#c2631f”),c(1,2,3,4,5,6,7,8),na.color = “transparent”) map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;% leaflet::addProviderTiles(“CartoDB.Positron”,group = “CartoDB.Positron”) %&gt;% # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs(‘EPSG:4326’)),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color=“#0327cd”) %&gt;% leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths<span class="math inline">\(levpa_id==branch_polys_selction\)</span>levpa_id,],sf::st_crs(‘EPSG:4326’)),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color=“#0327cd”) %&gt;% # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% leaflet::addRasterImage(flowdir_d8_burned_filled, colors = pal, opacity = 1,maxBytes=42<em>1024</em>1024) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color=“black”) %&gt;% # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4]) leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4]) # addLegend(pal = pal, values = terra::values(dem_meters), title = “Elevation data for Santander (mts)”) map1 mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_flowdir.png”),fsep = .Platform$file.sep))</p>
<p>}</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a></a></span>
<span id="cb8-2"><a></a><span class="al">![](./vis/HUC01050002_selectlevel_flowdir.png)</span></span>
<span id="cb8-3"><a></a></span>
<span id="cb8-4"><a></a><span class="fu">## The FIM Pipeline: Burned &amp; Filled Flow Direction</span></span>
<span id="cb8-5"><a></a></span>
<span id="cb8-6"><a></a><span class="in">```{r, bf,echo = FALSE}</span></span>
<span id="cb8-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002_selectlevel_BFflowdir.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb8-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb8-9"><a></a><span class="in">  </span></span>
<span id="cb8-10"><a></a><span class="in">  # flowdir_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"flowdir_d8_burned_filled.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb8-11"><a></a><span class="in">  flowdir_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("flowdir_d8_burned_filled_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb8-12"><a></a><span class="in">  pal &lt;- leaflet::colorFactor(c("#862627","#26207a","#6563b7","#6563b7","#cbc6c0","#fee08a","#f4a429","#c2631f"),c(1,2,3,4,5,6,7,8),na.color = "transparent")</span></span>
<span id="cb8-13"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb8-14"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb8-15"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb8-16"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths$levpa_id==branch_polys_selction$levpa_id,],sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb8-17"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb8-18"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb8-19"><a></a><span class="in">    leaflet::addRasterImage(flowdir_d8_burned_filled, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb8-20"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb8-21"><a></a><span class="in">    # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb8-22"><a></a><span class="in">    leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb8-23"><a></a><span class="in">  # addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb8-24"><a></a><span class="in">  map1</span></span>
<span id="cb8-25"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb8-26"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb8-27"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb8-28"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb8-29"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("HUC01050002_selectlevel_BFflowdir.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb8-30"><a></a></span>
<span id="cb8-31"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002_selectlevel_BFflowdir.png"></p>
</section>
<section id="the-fim-pipeline-flow-accumulation" class="slide level2">
<h2>The FIM Pipeline: Flow Accumulation</h2>
<p>```{{r, fa, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_faBFflowdir.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p>flowaccum_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,“branches”,“0”,“flowaccum_d8_burned_filled_0.tif”,fsep = .Platform<span class="math inline">\(file.sep))
  pal &lt;- leaflet::colorFactor(c("#862627","#26207a","#6563b7","#6563b7","#cbc6c0","#fee08a","#f4a429","#c2631f"),c(1,2,3,4,5,6,7,8),na.color = "transparent")
  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%
    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%
    # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%
    leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths\)</span>levpa_id==branch_polys_selction<span class="math inline">\(levpa_id,],sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%
    leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%
    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%
    leaflet::addRasterImage(flowaccum_d8_burned_filled, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%
    leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])
  # addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")
  map1
  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep),vwidth = 1080,vheight = 1080) magick::image_write( magick::image_read( cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep), border_size = 4,just = "center")
    ),file.path(path_to_output,glue::glue("HUC01050002_selectlevel_faBFflowdir.png"),fsep = .Platform\)</span>file.sep))</p>
<p>}</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a></a></span>
<span id="cb9-2"><a></a><span class="al">![](./vis/HUC01050002_selectlevel_faBFflowdir.png)</span></span>
<span id="cb9-3"><a></a></span>
<span id="cb9-4"><a></a><span class="fu">## The FIM Pipeline: Slope</span></span>
<span id="cb9-5"><a></a></span>
<span id="cb9-6"><a></a><span class="in">```{r,slope, echo = FALSE}</span></span>
<span id="cb9-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002_selectlevel_Slope.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb9-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb9-9"><a></a></span>
<span id="cb9-10"><a></a><span class="in">  # slopes_d8_dem_meters &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","slopes_d8_dem_meters_masked_0.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb9-11"><a></a><span class="in">  slopes_d8_dem_meters &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("slopes_d8_dem_meters_masked_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb9-12"><a></a><span class="in">  pal &lt;- leaflet::colorFactor(c("#862627","#26207a","#6563b7","#6563b7","#cbc6c0","#fee08a","#f4a429","#c2631f"),c(1,2,3,4,5,6,7,8),na.color = "transparent")</span></span>
<span id="cb9-13"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb9-14"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb9-15"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb9-16"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths$levpa_id==branch_polys_selction$levpa_id,],sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb9-17"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb9-18"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb9-19"><a></a><span class="in">    leaflet::addRasterImage(slopes_d8_dem_meters, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb9-20"><a></a><span class="in">    leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb9-21"><a></a><span class="in">  # addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb9-22"><a></a><span class="in">  map1</span></span>
<span id="cb9-23"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb9-24"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb9-25"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb9-26"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb9-27"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("HUC01050002_selectlevel_Slope.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb9-28"><a></a></span>
<span id="cb9-29"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002_selectlevel_Slope.png"></p>
<p>test</p>
</section>
<section id="the-fim-pipeline-dem-derived-reaches" class="slide level2">
<h2>The FIM Pipeline: DEM Derived Reaches</h2>
<p>```{{r, demreach, echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_snreach.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p># sn_demDerived_reaches &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,“branches”,“0”,“demDerived_reaches_0.shp”,fsep = .Platform<span class="math inline">\(file.sep))
  # sn_catchemnt_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","sn_catchments_reaches_0.tif",fsep = .Platform\)</span>file.sep)) sn_demDerived_reaches &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,“branches”,branch_polys_selction<span class="math inline">\(levpa_id,glue::glue("demDerived_reaches_{branch_polys_selction\)</span>levpa_id}.shp”),fsep = .Platform<span class="math inline">\(file.sep))
  sn_catchemnt_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction\)</span>levpa_id,glue::glue(“sn_catchments_reaches_{branch_polys_selction<span class="math inline">\(levpa_id}.tif"),fsep = .Platform\)</span>file.sep))</p>
<p>catch_values &lt;- unique(terra::values(sn_catchemnt_reaches)) pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(catch_values)),catch_values,na.color = “transparent”) map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;% leaflet::addProviderTiles(“CartoDB.Positron”,group = “CartoDB.Positron”) %&gt;% leafem::addFeatures(data = sf::st_transform(sn_demDerived_reaches,sf::st_crs(‘EPSG:4326’)),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color=“#0327cd”) %&gt;% # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% leaflet::addRasterImage(sn_catchemnt_reaches, colors = pal, opacity = 1,maxBytes=42<em>1024</em>1024) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color=“black”) %&gt;% # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4]) leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4]) # addLegend(pal = pal, values = terra::values(dem_meters), title = “Elevation data for Santander (mts)”) mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_snreach.png”),fsep = .Platform$file.sep))</p>
<p>}</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb10-1"><a></a></span>
<span id="cb10-2"><a></a><span class="al">![](./vis/HUC01050002_selectlevel_snreach.png)</span></span>
<span id="cb10-3"><a></a></span>
<span id="cb10-4"><a></a><span class="fu">## The FIM Pipeline: Gage Weighted (gw) Reaches</span></span>
<span id="cb10-5"><a></a></span>
<span id="cb10-6"><a></a><span class="in">```{r, gwreach, echo = FALSE}</span></span>
<span id="cb10-7"><a></a><span class="in">if(!file.exists(file.path(path_to_output,glue::glue("HUC01050002_selectlevel_gwreach.png"),fsep = .Platform$file.sep))) {</span></span>
<span id="cb10-8"><a></a><span class="in">  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb10-9"><a></a><span class="in">  </span></span>
<span id="cb10-10"><a></a><span class="in">  # gw_catchments_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","gw_catchments_reaches_0.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb10-11"><a></a><span class="in">  gw_catchments_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("gw_catchments_reaches_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb10-12"><a></a><span class="in">  </span></span>
<span id="cb10-13"><a></a><span class="in">  catch_values &lt;- unique(terra::values(gw_catchments_reaches))</span></span>
<span id="cb10-14"><a></a><span class="in">  pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(catch_values)),catch_values,na.color = "transparent")</span></span>
<span id="cb10-15"><a></a><span class="in">  map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb10-16"><a></a><span class="in">    leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb10-17"><a></a><span class="in">    # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb10-18"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb10-19"><a></a><span class="in">    leaflet::addRasterImage(gw_catchments_reaches, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb10-20"><a></a><span class="in">    leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb10-21"><a></a><span class="in">    # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb10-22"><a></a><span class="in">    leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb10-23"><a></a><span class="in">  # addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb10-24"><a></a><span class="in">  mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = 1080,vheight = 1080)</span></span>
<span id="cb10-25"><a></a><span class="in">  magick::image_write(</span></span>
<span id="cb10-26"><a></a><span class="in">    magick::image_read(</span></span>
<span id="cb10-27"><a></a><span class="in">      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb10-28"><a></a><span class="in">    ),file.path(path_to_output,glue::glue("HUC01050002_selectlevel_gwreach.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb10-29"><a></a></span>
<span id="cb10-30"><a></a><span class="in">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img data-src="./vis/HUC01050002_selectlevel_gwreach.png"></p>
</section>
<section id="the-fim-pipeline-hand" class="slide level2">
<h2>The FIM Pipeline: HAND</h2>
<p>```{{r, HAND,echo = FALSE}} if(!file.exists(file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_HAND.png”),fsep = .Platform<span class="math inline">\(file.sep))) {
  unlink(file.path(path_to_tmp_output,"*",fsep = .Platform\)</span>file.sep))</p>
<p># HAND &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,“branches”,“0”,“rem_zeroed_masked_0.tif”,fsep = .Platform<span class="math inline">\(file.sep))
  HAND &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction\)</span>levpa_id,glue::glue(“rem_zeroed_masked_{branch_polys_selction<span class="math inline">\(levpa_id}.tif"),fsep = .Platform\)</span>file.sep))</p>
<p>HAND_values &lt;- terra::values(HAND) pal &lt;- leaflet::colorNumeric(RColorBrewer::brewer.pal(5, “Blues”), c(min(HAND_values,na.rm = TRUE),max(HAND_values,na.rm = TRUE)),na.color = “transparent”) map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;% leaflet::addProviderTiles(“CartoDB.Positron”,group = “CartoDB.Positron”) %&gt;% # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color=“#000000”) %&gt;% leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color=“#000000”) %&gt;% leaflet::addRasterImage(HAND, colors = pal, opacity = 1,maxBytes=50<em>1024</em>1024) %&gt;% leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs(‘EPSG:4326’)),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color=“black”) %&gt;% # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4]) leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4]) # addLegend(pal = pal, values = terra::values(dem_meters), title = “Elevation data for Santander (mts)”) mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue(“test.png”),fsep = .Platform<span class="math inline">\(file.sep),vwidth = 1080,vheight = 1080)
  magick::image_write(
    magick::image_read(
      cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform\)</span>file.sep), border_size = 4,just = “center”) ),file.path(path_to_tmp_output,glue::glue(“test_cropped.png”),fsep = .Platform$file.sep))</p>
<p>gg_df &lt;- as.data.frame(HAND,xy = T) gglegend &lt;- ggplot2::ggplot() + ggplot2::geom_raster(data = gg_df, ggplot2::aes(x = x, y = y, fill = rem_zeroed_masked_2678000065)) + ggplot2::scale_fill_stepsn(name = “HAND (m)”, colors =RColorBrewer::brewer.pal(5, “Blues”), breaks = round(seq(plyr::round_any(min(na.omit(gg_df<span class="math inline">\(rem_zeroed_masked_2678000065)), 10, f = floor),
                                                  plyr::round_any(max(na.omit(gg_df\)</span>rem_zeroed_masked_2678000065)), 10, f = ceiling), length = 7), 1), values = scales::rescale( seq(plyr::round_any(min(na.omit(gg_df<span class="math inline">\(rem_zeroed_masked_2678000065)), 10, f = floor),
                                     plyr::round_any(max(na.omit(gg_df\)</span>rem_zeroed_masked_2678000065)), 10, f = ceiling), length = 6))) llegend &lt;- cowplot::get_legend(gglegend) cowplot::save_plot(plot=cowplot::plot_grid(llegend),filename=file.path(path_to_tmp_output,glue::glue(“test_legend.png”),fsep = .Platform$file.sep))</p>
<p>map &lt;- magick::image_read(file.path(path_to_tmp_output,glue::glue(“test_cropped.png”),fsep = .Platform<span class="math inline">\(file.sep))
  legend &lt;- magick::image_read(file.path(path_to_tmp_output,glue::glue("test_legend.png"),fsep = .Platform\)</span>file.sep)) %&gt;% magick::image_trim() %&gt;% magick::image_fill( color = “transparent”, refcolor = “white”, fuzz = 4, point = “+1+1” ) %&gt;% magick::image_scale(“200”) magick::image_write(image = magick::image_mosaic(c(map, legend)),path=file.path(path_to_output,glue::glue(“HUC01050002_selectlevel_HAND.png”),fsep = .Platform$file.sep))</p>
<p>}</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a></a><span class="al">![](./vis/HUC01050002_selectlevel_HAND.png)</span></span>
<span id="cb11-2"><a></a></span>
<span id="cb11-3"><a></a><span class="fu">## These are all interactive too!</span></span>
<span id="cb11-4"><a></a></span>
<span id="cb11-5"><a></a><span class="in">```{r, HANDleaf,echo = FALSE}</span></span>
<span id="cb11-6"><a></a><span class="in">HAND &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("rem_zeroed_masked_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb11-7"><a></a><span class="in">HAND_values &lt;- terra::values(HAND)</span></span>
<span id="cb11-8"><a></a><span class="in">pal &lt;- leaflet::colorNumeric(RColorBrewer::brewer.pal(5, "Blues"), c(min(HAND_values,na.rm = TRUE),max(HAND_values,na.rm = TRUE)),na.color = "transparent")</span></span>
<span id="cb11-9"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb11-10"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb11-11"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths$levpa_id==branch_polys_selction$levpa_id,],sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb11-12"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb11-13"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb11-14"><a></a><span class="in">  leaflet::addRasterImage(HAND, colors = pal, opacity = 1,maxBytes=50*1024*1024) %&gt;%</span></span>
<span id="cb11-15"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb11-16"><a></a><span class="in">  # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb11-17"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb11-18"><a></a><span class="in">map1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="images-for-squirrels" class="slide level2">
<h2>Images for squirrels</h2>
<p><code>{r, gif,echo = FALSE} if(!file.exists(file.path(path_to_output,glue::glue("FIM4_gif"),fsep = .Platform$file.sep))) {   m &lt;- magick::image_animate(c(magick::image_read(file.path(path_to_output,"VPU1_HF_HUC.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_divide.png",fsep = .Platform$file.sep)),   # magick::image_read(file.path(path_to_output,"HUC01050002_schism.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_levels.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_levels_select.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_levels_select_lone.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_DEM.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_flows_grid_boolean.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_headwaters.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_flowdir.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_BFflowdir.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_faBFflowdir.png",fsep = .Platform$file.sep)),   # magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_Slope.png",fsep = .Platform$file.sep)),   # magick::image_read(file.path(path_to_output,HUC01050002_selectlevel_snreach.png,fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,"HUC01050002_selectlevel_gwreach.png",fsep = .Platform$file.sep)),   magick::image_read(file.path(path_to_output,HUC01050002_selectlevel_HAND.png,fsep = .Platform$file.sep))   ), fps = 1, loop = 1, dispose = "previous")   magick::image_write(m,file.path(path_to_output,glue::glue("FIM4_gif"),fsep = .Platform$file.sep)) }</code></p>
<p><img data-src="./vis/FIM4_gif.png"></p>
</section>
<section id="early-improvements" class="slide level2">
<h2>Early improvements</h2>
<ul>
<li>Sane(er) base data handling</li>
<li>10 fewer steps</li>
<li>68 seconds off pre-processing and 55 seconds off a branch</li>
</ul>
<p><img data-src="./vis/FIM4_HF_diagram.png"></p>
</section>
<section id="too-long" class="slide level2">
<h2>Too long</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a></a><span class="in">```{r}</span></span>
<span id="cb12-2"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-3"><a></a><span class="in"># FIM4</span></span>
<span id="cb12-4"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-5"><a></a><span class="in">library(magrittr)</span></span>
<span id="cb12-6"><a></a><span class="in"># library(leaflet)</span></span>
<span id="cb12-7"><a></a><span class="in"># library(leafgl)</span></span>
<span id="cb12-8"><a></a><span class="in"># remotes::install_github("doehm/cropcircles")</span></span>
<span id="cb12-9"><a></a></span>
<span id="cb12-10"><a></a><span class="in">unit_to_map &lt;- '01050002'</span></span>
<span id="cb12-11"><a></a></span>
<span id="cb12-12"><a></a><span class="in">path_to_current &lt;- file.path("~/data/output/FIM4_stock/",fsep = .Platform$file.sep)</span></span>
<span id="cb12-13"><a></a><span class="in">path_to_new &lt;- file.path("~/data/output/FIM4_refrepl/",fsep = .Platform$file.sep)</span></span>
<span id="cb12-14"><a></a><span class="in">path_to_output &lt;- file.path("~/data/output/vis",fsep = .Platform$file.sep)</span></span>
<span id="cb12-15"><a></a><span class="in">path_to_tmp_output &lt;- file.path(path_to_output,"tmp",fsep = .Platform$file.sep)</span></span>
<span id="cb12-16"><a></a><span class="in">path_to_maine_stock &lt;- file.path("~/Dropbox/root/projects/floodmapping/methods/OWP_FIM/outputs/FIM4_maine/",fsep = .Platform$file.sep)</span></span>
<span id="cb12-17"><a></a></span>
<span id="cb12-18"><a></a><span class="in">path_to_fim4_unit_outputs &lt;- path_to_maine_stock</span></span>
<span id="cb12-19"><a></a></span>
<span id="cb12-20"><a></a><span class="in">all_hucs &lt;- sf::st_read(file.path("~/Dropbox/root/database/hosted/water/HUC8.fgb",fsep = .Platform$file.sep))</span></span>
<span id="cb12-21"><a></a></span>
<span id="cb12-22"><a></a><span class="in">wbd8_clp_inputs &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"wbd8_clp.gpkg",fsep=.Platform$file.sep))</span></span>
<span id="cb12-23"><a></a><span class="in">levelpaths &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"nwm_subset_streams_levelPaths.gpkg",fsep = .Platform$file.sep))</span></span>
<span id="cb12-24"><a></a><span class="in">nearby_hucs &lt;- sf::st_transform(all_hucs,sf::st_crs(wbd8_clp_inputs))[wbd8_clp_inputs %&gt;% sf::st_buffer(1000),]</span></span>
<span id="cb12-25"><a></a></span>
<span id="cb12-26"><a></a><span class="in">hf_flowlines &lt;- arrow::open_dataset("~/data/raw/lynker-spatial/hydrofabric/v2.2/final/conus/conus_flowpaths/") %&gt;% dplyr::collect() %&gt;% sf::st_as_sf()</span></span>
<span id="cb12-27"><a></a><span class="in">sf::st_crs(hf_flowlines) &lt;- sf::st_crs("EPSG:5070")</span></span>
<span id="cb12-28"><a></a><span class="in">hf_divides &lt;- arrow::open_dataset("~/data/raw/lynker-spatial/hydrofabric/v2.2/final/conus/conus_divides/") %&gt;% dplyr::collect() %&gt;% sf::st_as_sf()</span></span>
<span id="cb12-29"><a></a><span class="in">sf::st_crs(hf_divides) &lt;- sf::st_crs("EPSG:5070")</span></span>
<span id="cb12-30"><a></a></span>
<span id="cb12-31"><a></a><span class="in">select_divides &lt;- hf_divides[sf::st_transform(wbd8_clp_inputs,sf::st_crs(hf_divides)),]</span></span>
<span id="cb12-32"><a></a><span class="in">select_flowlines &lt;- hf_flowlines[hf_flowlines$divide_id %in% select_divides$divide_id,]</span></span>
<span id="cb12-33"><a></a></span>
<span id="cb12-34"><a></a><span class="in"># Hydrofrabric maps (boundary conditions)</span></span>
<span id="cb12-35"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-36"><a></a><span class="in">forecast_basins &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"nwm_catchments_proj_subset.gpkg",fsep = .Platform$file.sep))</span></span>
<span id="cb12-37"><a></a><span class="in">forecast_basins_values &lt;- unique(forecast_basins$ID)</span></span>
<span id="cb12-38"><a></a><span class="in">forecast_basins_pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(forecast_basins_values)),forecast_basins_values,na.color = "transparent")</span></span>
<span id="cb12-39"><a></a><span class="in">forecast_network &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"nwm_subset_streams.gpkg",fsep = .Platform$file.sep))</span></span>
<span id="cb12-40"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-41"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-42"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(forecast_basins,sf::st_crs('EPSG:4326')),stroke = FALSE, opacity = 0.8,fillOpacity = 1,fill = TRUE,weight = 1,fillColor=forecast_basins_pal(forecast_basins$ID)) %&gt;%</span></span>
<span id="cb12-43"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(forecast_network,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="blue") %&gt;%</span></span>
<span id="cb12-44"><a></a><span class="in">  # leaflet::addLabelOnlyMarkers(data=sf::st_transform(forecast_basins %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb12-45"><a></a><span class="in">  #                              label = ~`ID`,</span></span>
<span id="cb12-46"><a></a><span class="in">  #                              labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb12-47"><a></a><span class="in">  #                              group="Index Labels") %&gt;%</span></span>
<span id="cb12-48"><a></a><span class="in">  leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-49"><a></a><span class="in">map1</span></span>
<span id="cb12-50"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-51"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-52"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-53"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-54"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-55"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-56"><a></a></span>
<span id="cb12-57"><a></a><span class="in"># Hydrofabric</span></span>
<span id="cb12-58"><a></a><span class="in">hydrofabric_divides_pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(select_divides$divide_id)),select_divides$divide_id,na.color = "transparent")</span></span>
<span id="cb12-59"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-60"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-61"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(select_divides,sf::st_crs('EPSG:4326')),stroke = FALSE, opacity = 0.8,fillOpacity = 1,fill = TRUE,weight = 1,fillColor=hydrofabric_divides_pal(select_divides$divide_id)) %&gt;%</span></span>
<span id="cb12-62"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(select_flowlines,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="blue") %&gt;%</span></span>
<span id="cb12-63"><a></a><span class="in">  # leaflet::addLabelOnlyMarkers(data=sf::st_transform(forecast_basins %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb12-64"><a></a><span class="in">  #                              label = ~`ID`,</span></span>
<span id="cb12-65"><a></a><span class="in">  #                              labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb12-66"><a></a><span class="in">  #                              group="Index Labels") %&gt;%</span></span>
<span id="cb12-67"><a></a><span class="in">  leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-68"><a></a><span class="in">map1</span></span>
<span id="cb12-69"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-70"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-71"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-72"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-73"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-74"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-75"><a></a></span>
<span id="cb12-76"><a></a><span class="in"># Test Flowlines</span></span>
<span id="cb12-77"><a></a><span class="in">hydrofabric_flowlpaths &lt;- sf::st_read("~/data/temp/test.gpkg",layer = 'flowpaths')</span></span>
<span id="cb12-78"><a></a><span class="in">hydrofabric_divides &lt;- sf::st_read("~/data/temp/test.gpkg",layer = 'divides')</span></span>
<span id="cb12-79"><a></a><span class="in">hydrofabric_flowlines &lt;- sf::st_read("~/data/temp/test.gpkg",layer = 'flowlines')</span></span>
<span id="cb12-80"><a></a><span class="in">hydrofabric_divides_pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(select_divides$divide_id)),select_divides$divide_id,na.color = "transparent")</span></span>
<span id="cb12-81"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-82"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-83"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(select_divides,sf::st_crs('EPSG:4326')),stroke = FALSE, opacity = 0.8,fillOpacity = 1,fill = TRUE,weight = 1,fillColor=hydrofabric_divides_pal(select_divides$divide_id)) %&gt;%</span></span>
<span id="cb12-84"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(select_flowlines,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="blue") %&gt;%</span></span>
<span id="cb12-85"><a></a><span class="in">  # leaflet::addLabelOnlyMarkers(data=sf::st_transform(forecast_basins %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb12-86"><a></a><span class="in">  #                              label = ~`ID`,</span></span>
<span id="cb12-87"><a></a><span class="in">  #                              labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb12-88"><a></a><span class="in">  #                              group="Index Labels") %&gt;%</span></span>
<span id="cb12-89"><a></a><span class="in">  leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-90"><a></a><span class="in">map1</span></span>
<span id="cb12-91"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-92"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-93"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-94"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-95"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-96"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-97"><a></a><span class="in"># ===============</span></span>
<span id="cb12-98"><a></a></span>
<span id="cb12-99"><a></a></span>
<span id="cb12-100"><a></a><span class="in"># Coastal</span></span>
<span id="cb12-101"><a></a><span class="in">basedir &lt;- "~/data/raw/nohrsc/owp_files/nwm/nwm_parameters/NWM_coastal_parameters.tar/coastal_parameters/coastal/atlgulf/"</span></span>
<span id="cb12-102"><a></a><span class="in">hgrid.gr3_file &lt;- file.path(basedir,"hgrid.gr3")</span></span>
<span id="cb12-103"><a></a><span class="in">hgrid.gr3 &lt;- data.table::fread(hgrid.gr3_file,skip = 2,nrows = 10537611-2)</span></span>
<span id="cb12-104"><a></a><span class="in">hgrid.gr3_sf &lt;- sfheaders::sf_point(</span></span>
<span id="cb12-105"><a></a><span class="in">  obj = hgrid.gr3</span></span>
<span id="cb12-106"><a></a><span class="in">  , x = "V2"</span></span>
<span id="cb12-107"><a></a><span class="in">  , y = "V3"</span></span>
<span id="cb12-108"><a></a><span class="in">  , z = "V4"</span></span>
<span id="cb12-109"><a></a><span class="in">  , keep = TRUE</span></span>
<span id="cb12-110"><a></a><span class="in">) |&gt; sf::st_set_crs(sf::st_crs("EPSG:6349")) %&gt;% </span></span>
<span id="cb12-111"><a></a><span class="in">  sf::st_transform(sf::st_crs("EPSG:4326"))</span></span>
<span id="cb12-112"><a></a><span class="in">schism_pts &lt;- hgrid.gr3_sf[sf::st_transform(wbd8_clp_inputs,sf::st_crs(hgrid.gr3_sf)) %&gt;% sf::st_make_valid(),]</span></span>
<span id="cb12-113"><a></a></span>
<span id="cb12-114"><a></a><span class="in"># Branch 0</span></span>
<span id="cb12-115"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-116"><a></a><span class="in">wbd_buffered_inputs &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"wbd_buffered.gpkg",fsep=.Platform$file.sep))</span></span>
<span id="cb12-117"><a></a><span class="in">branch_0_bbox &lt;- sf::st_bbox(sf::st_transform(wbd_buffered_inputs,sf::st_crs('EPSG:4326'))) %&gt;% unlist() %&gt;% unname()</span></span>
<span id="cb12-118"><a></a></span>
<span id="cb12-119"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-120"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-121"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs('EPSG:4326')),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.02,color="black") %&gt;%</span></span>
<span id="cb12-122"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-123"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-124"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-125"><a></a><span class="in">  leaflet::addLabelOnlyMarkers(data=sf::st_transform(nearby_hucs %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb12-126"><a></a><span class="in">                               label = ~`name`,</span></span>
<span id="cb12-127"><a></a><span class="in">                               labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb12-128"><a></a><span class="in">                               group="Index Labels") %&gt;%</span></span>
<span id="cb12-129"><a></a><span class="in">  leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-130"><a></a><span class="in">map1</span></span>
<span id="cb12-131"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-132"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-133"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-134"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-135"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-136"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-137"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-138"><a></a><span class="in">branch_polys &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"branch_polygons.gpkg",fsep = .Platform$file.sep))</span></span>
<span id="cb12-139"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-140"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-141"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs('EPSG:4326')),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.02,color="black") %&gt;%</span></span>
<span id="cb12-142"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-143"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-144"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-145"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-146"><a></a><span class="in">  leaflet::addLabelOnlyMarkers(data=sf::st_transform(branch_polys %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb12-147"><a></a><span class="in">                               label = ~`levpa_id`,</span></span>
<span id="cb12-148"><a></a><span class="in">                               labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb12-149"><a></a><span class="in">                               group="Index Labels") %&gt;%</span></span>
<span id="cb12-150"><a></a><span class="in">  leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-151"><a></a><span class="in">map1</span></span>
<span id="cb12-152"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-153"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-154"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-155"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-156"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-157"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-158"><a></a><span class="in"># BranchPolySelector===========================</span></span>
<span id="cb12-159"><a></a><span class="in">branch_polys_selction &lt;- branch_polys[25,] #2,11, 19</span></span>
<span id="cb12-160"><a></a><span class="in">aoi_bbox &lt;- sf::st_bbox(sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326'))) %&gt;% unlist() %&gt;% unname()</span></span>
<span id="cb12-161"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-162"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-163"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(schism_pts,sf::st_crs('EPSG:4326')),stroke = FALSE,opacity = 1,fillOpacity = 1,weight = 0.02,color="black") %&gt;%</span></span>
<span id="cb12-164"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-165"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-166"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-167"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(branch_polys,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-168"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=TRUE,opacity = 1,fillOpacity = 0.2,weight = 1,color="yellow") %&gt;%</span></span>
<span id="cb12-169"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 0.2,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-170"><a></a><span class="in">  leaflet::addLabelOnlyMarkers(data=sf::st_transform(branch_polys_selction %&gt;% sf::st_centroid(quiet = TRUE),sf::st_crs('EPSG:4326')),</span></span>
<span id="cb12-171"><a></a><span class="in">                               label = ~`levpa_id`,</span></span>
<span id="cb12-172"><a></a><span class="in">                               labelOptions = leaflet::labelOptions(noHide = T, sticky = T,textOnly = T),</span></span>
<span id="cb12-173"><a></a><span class="in">                               group="Index Labels") %&gt;%</span></span>
<span id="cb12-174"><a></a><span class="in">  # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-175"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-176"><a></a><span class="in">map1</span></span>
<span id="cb12-177"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-178"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-179"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-180"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-181"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-182"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-183"><a></a></span>
<span id="cb12-184"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-185"><a></a><span class="in">dem_meters &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"dem_meters.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-186"><a></a><span class="in">dem_meters &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("dem_meters_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-187"><a></a></span>
<span id="cb12-188"><a></a><span class="in">gg_df &lt;- as.data.frame(dem_meters,xy = T)</span></span>
<span id="cb12-189"><a></a><span class="in">gglegend &lt;- ggplot2::ggplot() +</span></span>
<span id="cb12-190"><a></a><span class="in">  ggplot2::geom_raster(data = gg_df, ggplot2::aes(x = x, y = y, fill = dem_meters_2678000065)) +</span></span>
<span id="cb12-191"><a></a><span class="in">  ggplot2::scale_fill_stepsn(name = "3DEP 10m (m)", </span></span>
<span id="cb12-192"><a></a><span class="in">                             colors =c("forestgreen","yellow","tan","brown"),</span></span>
<span id="cb12-193"><a></a><span class="in">                             breaks = seq(plyr::round_any(min(na.omit(gg_df$dem_meters_2678000065)), 10, f = floor),</span></span>
<span id="cb12-194"><a></a><span class="in">                                          plyr::round_any(max(na.omit(gg_df$dem_meters_2678000065)), 10, f = ceiling), length = 7),</span></span>
<span id="cb12-195"><a></a><span class="in">                             values = scales::rescale(</span></span>
<span id="cb12-196"><a></a><span class="in">                               seq(plyr::round_any(min(na.omit(gg_df$dem_meters_2678000065)), 10, f = floor),</span></span>
<span id="cb12-197"><a></a><span class="in">                                   plyr::round_any(max(na.omit(gg_df$dem_meters_2678000065)), 10, f = ceiling), length = 6))) </span></span>
<span id="cb12-198"><a></a><span class="in">llegend &lt;- cowplot::get_legend(gglegend)</span></span>
<span id="cb12-199"><a></a></span>
<span id="cb12-200"><a></a><span class="in">pal &lt;- leaflet::colorNumeric(c("forestgreen","yellow","tan","brown"), terra::values(dem_meters),na.color = "transparent")</span></span>
<span id="cb12-201"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-202"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-203"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-204"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths[levelpaths$levpa_id==branch_polys_selction$levpa_id,],sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-205"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb12-206"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-207"><a></a><span class="in">  # leafem::addGeoRaster(dem_meters,colorOptions = leafem:::colorOptions(palette = pal,</span></span>
<span id="cb12-208"><a></a><span class="in">  #                                                                      # breaks = as.numeric(c(0:xx$max_ffreq)),</span></span>
<span id="cb12-209"><a></a><span class="in">  #                                                                      domain = c(dem_meters_values_min,dem_meters_values_max))) %&gt;%</span></span>
<span id="cb12-210"><a></a><span class="in">  # leafem::addGeoRaster(dem_meters,color= pal) %&gt;%</span></span>
<span id="cb12-211"><a></a><span class="in">  leaflet::addRasterImage(dem_meters, colors = pal, opacity = 0.9,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb12-212"><a></a><span class="in">  # leaflet::addLegend("bottomleft",title = "3DEP 10m (m)", pal = pal, values = terra::values(dem_meters)) %&gt;% </span></span>
<span id="cb12-213"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-214"><a></a><span class="in">map1</span></span>
<span id="cb12-215"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep),vwidth = input$dimension[1])</span></span>
<span id="cb12-216"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-217"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-218"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-219"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-220"><a></a></span>
<span id="cb12-221"><a></a><span class="in">ggplot2::ggsave(cowplot::plot_grid(llegend, rel_widths = c(1)),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep),)</span></span>
<span id="cb12-222"><a></a><span class="in">holepuch_map &lt;- cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-223"><a></a><span class="in">magick::image_display(holepuch_map)</span></span>
<span id="cb12-224"><a></a></span>
<span id="cb12-225"><a></a><span class="in">magick::image_read(holepuch_map)</span></span>
<span id="cb12-226"><a></a><span class="in">magick::image_read(test)</span></span>
<span id="cb12-227"><a></a></span>
<span id="cb12-228"><a></a><span class="in">magick::image_mosaic(c(bigdata, logo, frink))</span></span>
<span id="cb12-229"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-230"><a></a></span>
<span id="cb12-231"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-232"><a></a><span class="in">flows_grid_boolean &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"flows_grid_boolean.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-233"><a></a><span class="in">flows_grid_boolean &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("flows_grid_boolean_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep)) %&gt;%</span></span>
<span id="cb12-234"><a></a><span class="in">  terra::classify(cbind(-Inf, 0, NA), right=TRUE)</span></span>
<span id="cb12-235"><a></a><span class="in">pal &lt;- leaflet::colorFactor(c("black","blue"), c(0,1),na.color = "transparent")</span></span>
<span id="cb12-236"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-237"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-238"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-239"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-240"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-241"><a></a><span class="in">  leaflet::addRasterImage(flows_grid_boolean, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb12-242"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-243"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-244"><a></a><span class="in">map1</span></span>
<span id="cb12-245"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-246"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-247"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-248"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-249"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-250"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-251"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-252"><a></a><span class="in">headwaters &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"nwm_headwater_points_subset.gpkg",fsep = .Platform$file.sep))</span></span>
<span id="cb12-253"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-254"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-255"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-256"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-257"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-258"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb12-259"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(headwaters,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,radius = 2,color="#FF0000") %&gt;%</span></span>
<span id="cb12-260"><a></a><span class="in">  # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-261"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-262"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-263"><a></a><span class="in">map1</span></span>
<span id="cb12-264"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-265"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-266"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-267"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-268"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-269"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-270"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-271"><a></a><span class="in">flowdir_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"flowdir_d8_burned_filled.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-272"><a></a><span class="in">flowdir_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("flowdir_d8_burned_filled_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-273"><a></a><span class="in">pal &lt;- leaflet::colorFactor(c("#862627","#26207a","#6563b7","#6563b7","#cbc6c0","#fee08a","#f4a429","#c2631f"),c(1,2,3,4,5,6,7,8),na.color = "transparent")</span></span>
<span id="cb12-274"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-275"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-276"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-277"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-278"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-279"><a></a><span class="in">  leaflet::addRasterImage(flowdir_d8_burned_filled, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb12-280"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb12-281"><a></a><span class="in">  # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-282"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-283"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-284"><a></a><span class="in">map1</span></span>
<span id="cb12-285"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-286"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-287"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-288"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-289"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-290"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-291"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-292"><a></a><span class="in">flowaccum_d8_burned_filled &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","flowaccum_d8_burned_filled_0.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-293"><a></a><span class="in">pal &lt;- leaflet::colorFactor(c("#862627","#26207a","#6563b7","#6563b7","#cbc6c0","#fee08a","#f4a429","#c2631f"),c(1,2,3,4,5,6,7,8),na.color = "transparent")</span></span>
<span id="cb12-294"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-295"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-296"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-297"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-298"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-299"><a></a><span class="in">  leaflet::addRasterImage(flowaccum_d8_burned_filled, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb12-300"><a></a><span class="in">  leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-301"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-302"><a></a><span class="in">map1</span></span>
<span id="cb12-303"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-304"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-305"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-306"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-307"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-308"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-309"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-310"><a></a><span class="in">slopes_d8_dem_meters &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","slopes_d8_dem_meters_masked_0.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-311"><a></a><span class="in">slopes_d8_dem_meters &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("slopes_d8_dem_meters_masked_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-312"><a></a><span class="in">pal &lt;- leaflet::colorFactor(c("#862627","#26207a","#6563b7","#6563b7","#cbc6c0","#fee08a","#f4a429","#c2631f"),c(1,2,3,4,5,6,7,8),na.color = "transparent")</span></span>
<span id="cb12-313"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-314"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-315"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(levelpaths,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-316"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-317"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-318"><a></a><span class="in">  leaflet::addRasterImage(flowaccum_d8_burned_filled, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb12-319"><a></a><span class="in">  leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-320"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-321"><a></a><span class="in">map1</span></span>
<span id="cb12-322"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-323"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-324"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-325"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-326"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-327"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-328"><a></a></span>
<span id="cb12-329"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-330"><a></a><span class="in">sn_demDerived_reaches &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","demDerived_reaches_0.shp",fsep = .Platform$file.sep))</span></span>
<span id="cb12-331"><a></a><span class="in">sn_catchemnt_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","sn_catchments_reaches_0.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-332"><a></a><span class="in">sn_demDerived_reaches &lt;- sf::st_read(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("demDerived_reaches_{branch_polys_selction$levpa_id}.shp"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-333"><a></a><span class="in">sn_catchemnt_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("sn_catchments_reaches_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-334"><a></a></span>
<span id="cb12-335"><a></a><span class="in">catch_values &lt;- unique(terra::values(sn_catchemnt_reaches))</span></span>
<span id="cb12-336"><a></a><span class="in">pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(catch_values)),catch_values,na.color = "transparent")</span></span>
<span id="cb12-337"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-338"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-339"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(sn_demDerived_reaches,sf::st_crs('EPSG:4326')),stroke = TRUE,opacity = 1,fillOpacity = 1,weight = 1,color="#0327cd") %&gt;%</span></span>
<span id="cb12-340"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-341"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-342"><a></a><span class="in">  leaflet::addRasterImage(sn_catchemnt_reaches, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb12-343"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb12-344"><a></a><span class="in">  # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-345"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-346"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-347"><a></a><span class="in">map1</span></span>
<span id="cb12-348"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-349"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-350"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-351"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-352"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-353"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-354"><a></a></span>
<span id="cb12-355"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-356"><a></a><span class="in">gw_catchments_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","gw_catchments_reaches_0.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-357"><a></a><span class="in">gw_catchments_reaches &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("gw_catchments_reaches_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-358"><a></a></span>
<span id="cb12-359"><a></a><span class="in">catch_values &lt;- unique(terra::values(gw_catchments_reaches))</span></span>
<span id="cb12-360"><a></a><span class="in">pal &lt;- leaflet::colorFactor(randomcoloR::distinctColorPalette(length(catch_values)),catch_values,na.color = "transparent")</span></span>
<span id="cb12-361"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-362"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-363"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-364"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-365"><a></a><span class="in">  leaflet::addRasterImage(gw_catchments_reaches, colors = pal, opacity = 1,maxBytes=42*1024*1024) %&gt;%</span></span>
<span id="cb12-366"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb12-367"><a></a><span class="in">  # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-368"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-369"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-370"><a></a><span class="in">map1</span></span>
<span id="cb12-371"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-372"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-373"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-374"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-375"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-376"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-377"><a></a><span class="in"># ===========================</span></span>
<span id="cb12-378"><a></a><span class="in">HAND &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches","0","rem_zeroed_masked_0.tif",fsep = .Platform$file.sep))</span></span>
<span id="cb12-379"><a></a><span class="in">HAND &lt;- terra::rast(file.path(path_to_fim4_unit_outputs,unit_to_map,"branches",branch_polys_selction$levpa_id,glue::glue("rem_zeroed_masked_{branch_polys_selction$levpa_id}.tif"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-380"><a></a></span>
<span id="cb12-381"><a></a><span class="in">HAND_values &lt;- terra::values(HAND)</span></span>
<span id="cb12-382"><a></a><span class="in">pal &lt;- leaflet::colorNumeric(RColorBrewer::brewer.pal(5, "Blues"), c(min(HAND_values,na.rm = TRUE),max(HAND_values,na.rm = TRUE)),na.color = "transparent")</span></span>
<span id="cb12-383"><a></a><span class="in">map1 &lt;- leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE)) %&gt;%</span></span>
<span id="cb12-384"><a></a><span class="in">  leaflet::addProviderTiles("CartoDB.Positron",group = "CartoDB.Positron") %&gt;%</span></span>
<span id="cb12-385"><a></a><span class="in">  # leafem::addFeatures(data = sf::st_transform(wbd8_clp_inputs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1.2,color="#000000") %&gt;%</span></span>
<span id="cb12-386"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(nearby_hucs,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 1,color="#000000") %&gt;%</span></span>
<span id="cb12-387"><a></a><span class="in">  leaflet::addRasterImage(HAND, colors = pal, opacity = 1,maxBytes=50*1024*1024) %&gt;%</span></span>
<span id="cb12-388"><a></a><span class="in">  leafem::addFeatures(data = sf::st_transform(branch_polys_selction,sf::st_crs('EPSG:4326')),stroke=TRUE,fill=FALSE,opacity = 1,fillOpacity = 1,weight = 2,color="black") %&gt;%</span></span>
<span id="cb12-389"><a></a><span class="in">  # leaflet::fitBounds(branch_0_bbox[3],branch_0_bbox[2],branch_0_bbox[1],branch_0_bbox[4])</span></span>
<span id="cb12-390"><a></a><span class="in">  leaflet::fitBounds(aoi_bbox[3],aoi_bbox[2],aoi_bbox[1],aoi_bbox[4])</span></span>
<span id="cb12-391"><a></a><span class="in"># addLegend(pal = pal, values = terra::values(dem_meters), title = "Elevation data for Santander (mts)")</span></span>
<span id="cb12-392"><a></a><span class="in">map1</span></span>
<span id="cb12-393"><a></a><span class="in">mapview::mapshot2(map1,file=file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-394"><a></a><span class="in">magick::image_write(</span></span>
<span id="cb12-395"><a></a><span class="in">  magick::image_read(</span></span>
<span id="cb12-396"><a></a><span class="in">    cropcircles::crop_circle(file.path(path_to_tmp_output,glue::glue("test.png"),fsep = .Platform$file.sep), border_size = 4,just = "center")</span></span>
<span id="cb12-397"><a></a><span class="in">  ),file.path(path_to_tmp_output,glue::glue("test_cropped.png"),fsep = .Platform$file.sep))</span></span>
<span id="cb12-398"><a></a><span class="in">unlink(file.path(path_to_tmp_output,"*",fsep = .Platform$file.sep))</span></span>
<span id="cb12-399"><a></a></span>
<span id="cb12-400"><a></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="OWPLogo.png" class="slide-logo"></p>
<div class="footer footer-default">
<p>Back to the <a href="https://github.com/NOAA-OWP/inundation-mapping">FIM4 repo</a> | <a href="./OWP_FIM.html">My page</a> | <a href="./now.html">now</a></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-text-resizer/revealjs-text-resizer.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-confetti/confetti.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'confetti': {"particleCount":150,"angle":90,"spread":360,"startVelocity":25,"decay":0.9,"gravity":0.65,"drift":0,"ticks":400,"colors":["#0366fc","#f54281","#1fd14f"],"shapes":null,"scalar":0.7,"zIndex":100,"disableForReducedMotion":false},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'default',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1920,

        height: 1080,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, RevealTextResizer, RevealConfetti, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>